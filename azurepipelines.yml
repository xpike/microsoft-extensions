name: 1.0.$(Rev:r)
jobs:
  - job:
    pool:
      vmImage: windows-latest
    steps:
      - task: DotNetCoreCLI@2
        displayName: Restore
        inputs:
          command: restore
          projects: |
            **/*.csproj

      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          command: build
          configuration: release
          arguments: --no-restore -p:Version=$(Build.BuildNumber).$(Build.BuildId)
          projects: |
            src/**/*.csproj

      - task: DotNetCoreCLI@2
        displayName: Test
        inputs:
          command: test
          configuration: debug
          publishTestResults: false
          arguments: --no-restore --logger trx -r $(Agent.TempDirectory)/TestResults -p:CollectCoverage=true -p:CoverletOutput="$(Agent.TempDirectory)/TestResults/" -p:CoverletOutputFormat="json%2cCobertura" -p:MergeWith="$(Agent.TempDirectory)/TestResults/coverage.json" 
          projects: |
            test/**/*.csproj

      - task: PublishCodeCoverageResults@1
        displayName: Publish code coverage results
        inputs:
          codeCoverageTool: "Cobertura"
          summaryFileLocation: "$(Agent.TempDirectory)/TestResults/coverage.cobertura.xml"

      - task: PublishTestResults@2
        displayName: Publish test results
        inputs:
          searchFolder: $(Agent.TempDirectory)/TestResults
          failTaskOnFailedTests: true
          mergeTestResults: true
          testResultsFormat: "VSTest"
          testResultsFiles: "**/TEST-*.trx"

      - task: DotNetCoreCLI@2
        displayName: Package unstable
        inputs:
          command: pack
          configuration: release
          arguments: --no-build -p:PackageVersion=$(Build.BuildNumber)-dev$(Build.BuildId) -o $(Build.ArtifactStagingDirectory)
          projects: |
            src/**/*.csproj

      - task: DotNetCoreCLI@2
        displayName: Package stable for Nuget
        inputs:
          command: pack
          configuration: release
          arguments: --no-build -p:PackageVersion=$(Build.BuildNumber) -o $(Build.ArtifactStagingDirectory)
          projects: |
            src/**/*.csproj

      - task: PublishBuildArtifacts@1
        displayName: Publish Build Artifact

    
      