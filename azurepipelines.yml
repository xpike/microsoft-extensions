name: 1.0.$(Rev:r)
jobs:
  - job:
    pool:
      vmImage: windows-latest
    steps:
      - task: DotNetCoreCLI@2
        displayName: Restore
        inputs:
          command: restore
          projects: |
            **/*.csproj

      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          command: build
          configuration: release
          arguments: --no-restore -p:Version=$(Build.BuildNumber).$(Build.BuildId)
          projects: |
            src/**/*.csproj

      - task: DotNetCoreCLI@2
        displayName: Test
        inputs:
          command: test
          configuration: debug
          publishTestResults: false
          restoreDirectory: $(Build.ArtifactStagingDirectory)
          arguments: --no-restore --logger trx -p:AltCover=true -p:AltCoverShowSummary=true -p:AltCoverCobertura=$(Build.ArtifactStagingDirectory)\coverage.xml -p:AltCoverForce=true -p:AltCoverPathFilter=test
          projects: |
            test/**/*.csproj

      - task: PublishCodeCoverageResults@1
        displayName: Publish code coverage results
        inputs:
          codeCoverageTool: "Cobertura"
          summaryFileLocation: $(Build.ArtifactStagingDirectory)\coverage.xml

      - task: PublishTestResults@2
        displayName: Publish test results
        inputs:
          searchFolder: $(Build.ArtifactStagingDirectory)
          failTaskOnFailedTests: true
          mergeTestResults: true

      - task: DotNetCoreCLI@2
        displayName: Package unstable
        inputs:
          command: pack
          configuration: release
          nobuild: true
          arguments: -p:PackageVersion=$(Build.BuildNumber)-dev$(Build.BuildId) -o $(Build.ArtifactStagingDirectory)
          projects: |
            src/**/*.csproj

      - task: DotNetCoreCLI@2
        displayName: Package stable for Nuget
        inputs:
          command: pack
          configuration: release
          nobuild: true
          arguments: -p:PackageVersion=$(Build.BuildNumber) -o $(Build.ArtifactStagingDirectory)
          projects: |
            src/**/*.csproj

      - task: PublishBuildArtifacts@1
        displayName: Publish Build Artifact

    
      